# --- 1. Snippets (Macros) ---
# (unsub_headers) {
#     replace_header List-Unsubscribe-Post "List-Unsubscribe=One-Click"
# }
#DEV we are putting this block directly in where it needs; delete if it works

# --- 2. Global Settings ---
$(hostname) = mail.domain286
$(primary_domain) = domain286
hostname $(hostname)

## Local and hosted domains
import /etc/maddy/conf.d/domains.conf # Sets value for $(extra_domains), used below
$(local_domains) = $(primary_domain) $(extra_domains)

## TLS files
# tls file /etc/ssl/server/mail/email.crt /etc/ssl/server/mail/email.key #DEV will not work!
### Any of these will wor because we did this: /usr/bin/setfacl -R -m u:maddy:rX /etc/letsencrypt/{live,archive}
tls file /etc/inkcert/le/live/$(primary_domain)/fullchain.pem /etc/inkcert/le/live/$(primary_domain)/privkey.pem
#tls file /etc/letsencrypt/live/$(primary_domain)/fullchain.pem /etc/letsencrypt/live/$(primary_domain)/privkey.pem
#tls file /etc/maddy/certs/$(primary_domain)/fullchain.pem /etc/maddy/certs/$(primary_domain)/privkey.pem # needs 'ln -sfn /etc/inkcert/le/live /etc/maddy/certs' or '/etc/letsencrypt/live /etc/maddy/certs'

## Active directory
state_dir /srv/email/maddy

# --- 3. Storage and Authentication ---
auth.pass_table local_authdb {
    table sql_table {
        driver postgres
        dsn "user=email password=emaildbpass286 dbname=email host=localhost sslmode=disable"
        table_name passwords
    }
}

storage.imapsql local_mailboxes {
    driver postgres
    # host= for the socket location, localhost is not as fast or secure because it goes through TLS
    dsn "user=email password=emaildbpass286 dbname=email host=/run/postgresql sslmode=disable"
    msg_store fs /srv/email/maddy/messages/
    check_domain $(local_domains)
}

# --- 4. Inbound Routing (Port 25) ---
msgpipeline local_routing {

    # Handling for the specific unsubscribe address
    import /etc/maddy/conf.d/unsubscribe.conf

    # Handling for customscripts
    import /etc/maddy/conf.d/customscripts.conf

    # Standard delivery for all local domains
    destination postmaster $(local_domains) {
        check {
            # Rspamd handles spam filtering and moves to Junk folder
            rspamd http://127.0.0.1:11333 {
                add_header_action quarantine
                rewrite_subj_action quarantine
            }
        }
        modify {
            # Aliases
            replace_rcpt file /etc/maddy/conf.d/aliases.conf
        }
        reroute {
            destination postmaster $(local_domains) {
                deliver_to &local_mailboxes
            }
            default_destination {
                deliver_to &remote_queue
            }
        }
    }
    
    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

# --- 5. Outbound Submission (Port 465/587) ---
submission tls://0.0.0.0:465 {
    auth &local_authdb
    
    deliver_to msgpipeline {
        # Per-domain Unsubscribe Headers
        source domain286 {
            modify {
                add_header List-Unsubscribe-Post ".*" "List-Unsubscribe=One-Click"
                add_header List-Unsubscribe ".*" "<mailto:unsubscribe@domain286>"
            }
            deliver_to &remote_queue
        }

        # Others
        import /etc/maddy/conf.d/unsub_domains.conf

        default_source {
            deliver_to &remote_queue
        }
    }
}

# Standard SMTP and remote delivery targets
smtp tcp://0.0.0.0:25 {
    limits {
        all rate 20 1s
    }
    dmarc yes
    check {
        # Standard checks for incoming mail
        spf
        dkim
    }
    deliver_to &local_routing
}

target.remote remote_queue {
    limits {
        destination rate 20 1s
    }
}