#!/bin/bash
#inkVerbSerf! verb.ink

# This runs installmaddymail and installrc as one job
## Prerequisite: setup of course, and verbemail if you wish an email tld other than .email
## Check prerequisites for those

# OPTIONAL Prerequesite:
## If restoring from a backupinkvmail backup, the .vbak file must be in vip

# How to use:
## ./installinkemail [ RoundCube webmail path - optional: '-n' to skip ] [ backup filename IF restoring from backupinkvmail backup, optional ]

# Eg:
## ./installinkemail # Auto-generated secure paths (different for RC BOX), no backup
## ./installinkemail roundcubesecretpath # RC BOX path
## ./installinkemail rcbase myemailfile.vbak # RC BOX path and backup source file
## ./installinkemail -n myemailfile.vbak  # Backup, no other settings

usagenotes="This runs installmaddymail and installrc as one job"
usageformat="installinkemail [ RoundCube webmail path ] [ PostfixAdmin email pfa path - optional: if no other arguments and same as RoundCube ] [ PostfixAdmin setup password - optional: 'no' to skip ] [ backup filename IF restoring from backupinkvmail backup, optional ]"
usageexample="installinkemail # Auto-generated secure paths (different for RC BOX), no backup
installinkemail roundcubesecretpath # RC BOX path
installinkemail rcbase myemailfile.vbak # RC BOX path and backup source file
installinkemail -n myemailfile.vbak  # Backup, no other settings"
hierarchy=( oversight )
vsetnames=(  )
vsettypes=(  )
voptnames=( "RoundCube web path" "Email backup file" )
vopttypes=( 'isazAZ09lines || string_match' "www/vip/verb.vmail.*.vbak backup file name and location" )
voptflags=( n )
voptflagpurpose=( "No Roudcube Box setup password, but using backup email file" )
dependencyinstall=(  )
prerequesite=( "inkCert certs should be installled for at least the emailTLDURI and nameURI for this verber" )
usedby=(  )
useserfs=( installpostfixemail installrc )
useconfigs=( siteurilist )
if [ -n "$infoINKonly" ] && [ "$infoINKonly" = "true" ]; then return 0; fi # Must have for proper usage to not run the full serf
if [ -e "/opt/verb/mods/installinkemail.replace" ]; then . /opt/verb/mods/installinkemail.replace; return 0; fi # Replaces this script
if [ -e "/opt/verb/mods/installinkemail.before" ]; then . /opt/verb/mods/installinkemail.before; fi # Precedes this script


# Include the config
. /opt/verb/conf/siteurilist

# BOX folder
if [ -n "$1" ] && [ "$1" != "-n" ]; then
  boxfolder="$1"
else
  boxfolder="$(/usr/bin/pwgen -0 5 1)"
fi

# Postfix vmail
/opt/verb/serfs/installmaddymail
e="$?"; [[ "$e" = "0" ]] || exit "$e"

# Roundcube
/opt/verb/serfs/installrc ${boxfolder}
e="$?"; [[ "$e" = "0" ]] || exit "$e"

# Backup
if [ -n "$2" ]; then
  backupRestore=$2
  /opt/verb/serfs/backupinkvmailrestore ${backupRestore}
  e="$?"; [[ "$e" = "0" ]] || exit "$e"
fi

# inkCert check and FYI
if /bin/grep -Fq "InkCerted=NO" /opt/verb/conf/inkcert/cli-ini/siteinkcert.${emailTLDURI}; then
  /bin/echo "Note: ${emailTLDURI} still doesn't have proper SSL certs. You can install, but will get SSL warnings due to \"self-signed\" or \"snakeoil\" certs.
You may ignore these warnings if you choose. If you want proper SSL certs, you still need to run inkCert for ${emailTLDURI}.
"
fi

# Finished
/bin/echo "
You must restart the server in order for email boxes to send and receive.

Roundcube:
- https://box.${emailTLDURI}/${boxfolder}
"




if [ -e "/opt/verb/mods/installinkemail.after" ]; then . /opt/verb/mods/installinkemail.after; fi # Follows this script
